--[[ 
    Nebula UI Library
    The Ultimate Roblox Interface
    By: AI Assistant
    
    Features:
    - Beautiful Glassmorphism Design
    - Custom Hue/Saturation Color Picker
    - Tab System with Icons
    - Draggable Window (Desktop & Mobile)
    - Config Saving/Loading
    - Animated Notifications
    - All Standard Elements: Button, Toggle, Slider, Input, Dropdown, Keybind, Label, etc.
--]]

local Library = {}

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local TextService = game:GetService("TextService")
local Lighting = game:GetService("Lighting")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer

-- Internal References
local Assets = {
    Icons = {
        Settings = "rbxassetid://3926305904",
        Home = "rbxassetid://3926305904",
        List = "rbxassetid://3926305904",
        User = "rbxassetid://3926305904",
    }
}

-- Theme Engine
local DefaultTheme = {
    Main = Color3.fromRGB(20, 20, 25),
    Secondary = Color3.fromRGB(25, 25, 30),
    Accent = Color3.fromRGB(88, 101, 242),
    Text = Color3.fromRGB(255, 255, 255),
    TextDim = Color3.fromRGB(130, 130, 150),
    Border = Color3.fromRGB(40, 40, 50),
    Success = Color3.fromRGB(46, 204, 113),
    Warning = Color3.fromRGB(241, 196, 15),
    Error = Color3.fromRGB(231, 76, 60),
    BlurAmount = 24
}

local function DeepCopy(original)
    local copy
    if type(original) == 'table' then
        copy = {}
        for key, value in next, original, nil do
            copy[DeepCopy(key)] = DeepCopy(value)
        end
        setmetatable(copy, DeepCopy(getmetatable(original)))
    else -- number, string, boolean, etc
        copy = original
    end
    return copy
end

-- Utility
local Utility = {}

function Utility:Tween(Object, Info, Goal, Override)
    if not Object or not Object.Parent then return end
    local Tween = TweenService:Create(Object, TweenInfo.new(unpack(Info)), Goal)
    Tween:Play()
    return Tween
end

function Utility:Create(Class, Props)
    local Obj = Instance.new(Class)
    for i, v in pairs(Props) do
        if i ~= "Parent" then Obj[i] = v end
    end
    return Obj
end

function Utility:Circle(Obj, Radius)
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, Radius or 4)
    Corner.Parent = Obj
    return Corner
end

function Utility:Stroke(Obj, Color, Thickness)
    local Stroke = Instance.new("UIStroke")
    Stroke.Color = Color or Color3.fromRGB(255, 255, 255)
    Stroke.Thickness = Thickness or 1
    Stroke.Parent = Obj
    return Stroke
end

function Utility:Gradient(Obj, Color1, Color2, Rotation)
    local Grad = Instance.new("UIGradient")
    Grad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color1),
        ColorSequenceKeypoint.new(1, Color2)
    })
    Grad.Rotation = Rotation or 45
    Grad.Parent = Obj
    return Grad
end

function Utility:Padding(Obj, Top, Bottom, Left, Right)
    local Pad = Instance.new("UIPadding")
    Pad.PaddingTop = UDim.new(0, Top or 5)
    Pad.PaddingBottom = UDim.new(0, Bottom or 5)
    Pad.PaddingLeft = UDim.new(0, Left or 5)
    Pad.PaddingRight = UDim.new(0, Right or 5)
    Pad.Parent = Obj
    return Pad
end

function Utility:FromHex(Hex)
    Hex = Hex:gsub("#", "")
    return Color3.fromRGB(tonumber("0x"..Hex:sub(1,2)), tonumber("0x"..Hex:sub(3,4)), tonumber("0x"..Hex:sub(5,6)))
end

function Utility:ToHex(Color)
    return string.format("#%02X%02X%02X", Color.R*255, Color.G*255, Color.B*255)
end

-- Window Logic
function Library:Create(Config)
    Config = Config or {}
    
    -- Core Variables
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "NebulaUI_" .. (Config.Name or "Window")
    ScreenGui.DisplayOrder = 100
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    if syn then syn.protect_gui(ScreenGui, game:GetService("CoreGui")) end
    ScreenGui.Parent = CoreGui
    
    local Theme = DeepCopy(DefaultTheme)
    if Config.Theme then for k, v in pairs(Config.Theme) do Theme[k] = v end end

    -- Window Frame
    local WindowFrame = Utility:Create("Frame", {
        Size = Config.Size or UDim2.new(0, 550, 0, 400),
        Position = UDim2.new(0.5, -275, 0.5, -200),
        BackgroundColor3 = Theme.Main,
        Parent = ScreenGui,
        ZIndex = 10
    })
    Utility:Circle(WindowFrame, 12)
    Utility:Stroke(WindowFrame, Theme.Border)
    
    -- Blur
    local Blur = Instance.new("BlurEffect", Lighting)
    Blur.Size = 0
    Blur.Name = ScreenGui.Name .. "_Blur"
    
    task.spawn(function()
        Utility:Tween(Blur, {0.5}, {Size = Theme.BlurAmount})
        Utility:Tween(WindowFrame, {0.4, Enum.EasingStyle.Back}, {Size = WindowFrame.Size}) -- Intro Animation
        WindowFrame.Size = UDim2.new(0, 0, 0, 0) 
    end)

    -- Title Bar
    local TitleBar = Utility:Create("Frame", {
        Size = UDim2.new(1, 0, 0, 35),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = Theme.Secondary,
        ZIndex = 11,
        Parent = WindowFrame
    })
    local TitleCorner = Utility:Circle(TitleBar, 12)
    local TitleMask = Utility:Create("Frame", {
        Size = UDim2.new(1, 0, 0, 10),
        Position = UDim2.new(0, 0, 1, -10),
        BackgroundColor3 = Theme.Secondary,
        ZIndex = 11,
        Parent = TitleBar
    })

    local TitleText = Utility:Create("TextLabel", {
        Size = UDim2.new(1, -100, 1, 0),
        Position = UDim2.new(0, 20, 0, 0),
        BackgroundTransparency = 1,
        Text = Config.Name or "Nebula UI",
        TextColor3 = Theme.Text,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 12,
        Parent = TitleBar
    })

    -- Controls
    local MinBtn = Utility:Create("TextButton", {
        Size = UDim2.new(0, 30, 0, 20),
        Position = UDim2.new(1, -70, 0.5, -10),
        BackgroundColor3 = Theme.Accent,
        Text = "-",
        TextColor3 = Color3.fromRGB(255,255,255),
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        ZIndex = 12,
        Parent = TitleBar
    })
    Utility:Circle(MinBtn, 4)

    local CloseBtn = Utility:Create("TextButton", {
        Size = UDim2.new(0, 30, 0, 20),
        Position = UDim2.new(1, -35, 0.5, -10),
        BackgroundColor3 = Theme.Error,
        Text = "x",
        TextColor3 = Color3.fromRGB(255,255,255),
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        ZIndex = 12,
        Parent = TitleBar
    })
    Utility:Circle(CloseBtn, 4)

    -- Layout
    local TabLayout = Utility:Create("Frame", {
        Size = UDim2.new(0, 140, 1, -35),
        Position = UDim2.new(0, 0, 0, 35),
        BackgroundColor3 = Theme.Secondary,
        ZIndex = 10,
        Parent = WindowFrame
    })
    local TabList = Utility:Create("ScrollingFrame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 0,
        Parent = TabLayout
    })
    local TabListLayout = Instance.new("UIListLayout", TabList)
    TabListLayout.Padding = UDim.new(0, 5)
    TabListLayout.Parent = TabList

    local ContentLayout = Utility:Create("Frame", {
        Size = UDim2.new(1, -140, 1, -35),
        Position = UDim2.new(0, 140, 0, 35),
        BackgroundColor3 = Theme.Main,
        ZIndex = 10,
        Parent = WindowFrame
    })

    -- Drag Logic (Desktop & Mobile)
    local Dragging, DragInput, DragStart, StartPos
    TitleBar.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 or Input.UserInputType == Enum.UserInputType.Touch then
            Dragging = true
            DragStart = Input.Position
            StartPos = WindowFrame.Position
            Input.Changed:Connect(function() if Input.UserInputState == Enum.UserInputState.End then Dragging = false end end)
        end
    end)

    TitleBar.InputChanged:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseMovement or Input.UserInputType == Enum.UserInputType.Touch then
            DragInput = Input
        end
    end)

    UserInputService.InputChanged:Connect(function(Input)
        if Input == DragInput and Dragging then
            local Delta = Input.Position - DragStart
            Utility:Tween(WindowFrame, {0.15}, {Position = UDim2.new(StartPos.X.Scale, StartPos.X.Offset + Delta.X, StartPos.Y.Scale, StartPos.Y.Offset + Delta.Y)})
        end
    end)

    -- State
    local State = {
        Tabs = {},
        Open = true,
        ConfigName = Config.ConfigName or "NebulaConfig"
    }

    local Window = {
        SetTitle = function(Text) TitleText.Text = Text end,
        GetTheme = function() return Theme end,
        Close = function()
            Utility:Tween(WindowFrame, {0.3, Enum.EasingStyle.Back}, {Size = UDim2.new(0, 0, 0, 0)})
            Utility:Tween(Blur, {0.3}, {Size = 0})
            task.wait(0.3)
            ScreenGui:Destroy()
            Blur:Destroy()
        end,
        Toggle = function()
            State.Open = not State.Open
            if State.Open then
                ScreenGui.Enabled = true
                Utility:Tween(Blur, {0.3}, {Size = Theme.BlurAmount})
                Utility:Tween(WindowFrame, {0.4, Enum.EasingStyle.Back}, {Size = Config.Size or UDim2.new(0, 550, 0, 400)})
            else
                Utility:Tween(Blur, {0.3}, {Size = 0})
                Utility:Tween(WindowFrame, {0.3, Enum.EasingStyle.Back}, {Size = UDim2.new(0, 0, 0, 0)})
                task.wait(0.3)
                ScreenGui.Enabled = false
            end
        end,
        Notify = function(Title, Content, Duration, Type)
            Type = Type or "Info"
            Duration = Duration or 5
            
            local NotifGui = Utility:Create("ScreenGui", {Parent = CoreGui})
            local Color = Theme.Accent
            if Type == "Error" then Color = Theme.Error
            elseif Type == "Success" then Color = Theme.Success
            elseif Type == "Warning" then Color = Theme.Warning end

            local Holder = Utility:Create("Frame", {
                Size = UDim2.new(0, 300, 0, 50),
                Position = UDim2.new(1, 320, 1, -70),
                BackgroundColor3 = Theme.Secondary,
                Parent = NotifGui
            })
            Utility:Circle(Holder, 8)
            Utility:Stroke(Holder, Color)
            
            local Icon = Utility:Create("TextLabel", {
                Size = UDim2.new(0, 40, 1, 0),
                BackgroundTransparency = 1,
                Text = "!",
                TextSize = 24,
                Font = Enum.Font.GothamBold,
                TextColor3 = Color,
                Parent = Holder
            })
            
            local TText = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -50, 1, 0),
                Position = UDim2.new(0, 40, 0, 0),
                BackgroundTransparency = 1,
                Text = Title,
                TextSize = 14,
                Font = Enum.Font.GothamBold,
                TextColor3 = Theme.Text,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Holder
            })

            local ContentText = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -20, 1, 0),
                Position = UDim2.new(0, 10, 0, 25),
                BackgroundTransparency = 1,
                Text = Content,
                TextSize = 12,
                Font = Enum.Font.Gotham,
                TextColor3 = Theme.TextDim,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextYAlignment = Enum.TextYAlignment.Top,
                Parent = Holder
            })

            -- Animate In
            local YPos = Holder.Position.Y.Offset
            Holder.Size = UDim2.new(0, 0, 0, 50)
            Utility:Tween(Holder, {0.4, Enum.EasingStyle.Quart}, {
                Size = UDim2.new(0, 300, 0, math.max(50, (string.len(Content) > 40 and 70 or 50))),
                Position = UDim2.new(1, -310, 1, -(math.max(50, (string.len(Content) > 40 and 70 or 50)) + 20))
            })
            
            if Content:len() > 40 then
                Holder.Size = UDim2.new(0, 300, 0, 70)
            end

            task.delay(Duration, function()
                Utility:Tween(Holder, {0.4, Enum.EasingStyle.Quart}, {Position = UDim2.new(1, 320, 1, YPos)})
                task.wait(0.4)
                NotifGui:Destroy()
            end)
        end,
        SaveConfig = function()
            local Data = {}
            for i, Tab in pairs(State.Tabs) do
                Data[Tab.Name] = Tab.ConfigData or {}
            end
            writefile(State.ConfigName .. ".json", HttpService:JSONEncode(Data))
        end,
        LoadConfig = function()
            if isfile(State.ConfigName .. ".json") then
                local Data = HttpService:JSONDecode(readfile(State.ConfigName .. ".json"))
                for i, Tab in pairs(State.Tabs) do
                    if Data[Tab.Name] then
                        Tab:ApplyData(Data[Tab.Name])
                    end
                end
            end
        end
    }

    MinBtn.MouseButton1Click:Connect(function() Window.Toggle() end)
    CloseBtn.MouseButton1Click:Connect(function() Window.Close() end)

    -- TAB SYSTEM
    function Window:Tab(Name, Icon)
        Name = Name or "Tab"
        
        local TabObj = {}
        TabObj.Name = Name
        TabObj.ConfigData = {}
        
        -- Tab Button
        local TabBtn = Utility:Create("TextButton", {
            Size = UDim2.new(1, -10, 0, 35),
            BackgroundColor3 = Theme.Secondary,
            Text = "   " .. Name,
            TextColor3 = Theme.TextDim,
            TextSize = 13,
            Font = Enum.Font.GothamSemibold,
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 12,
            Parent = TabList
        })
        Utility:Circle(TabBtn, 6)
        Utility:Padding(TabBtn, 0, 0, 0, 0)
        
        if Icon then
            local Ico = Utility:Create("ImageLabel", {
                Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0, 10, 0.5, -8),
                Image = Icon,
                BackgroundTransparency = 1,
                Parent = TabBtn
            })
        end

        -- Tab Content
        local TabContent = Utility:Create("ScrollingFrame", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 4,
            ScrollBarImageColor3 = Theme.Secondary,
            Visible = false,
            Parent = ContentLayout
        })
        local ContentList = Instance.new("UIListLayout")
        ContentList.Padding = UDim.new(0, 8)
        ContentList.Parent = TabContent
        ContentList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            TabContent.CanvasSize = UDim2.new(0, 0, 0, ContentList.AbsoluteContentSize.Y + 10)
        end)

        -- Switch Logic
        TabBtn.MouseButton1Click:Connect(function()
            -- Reset others
            for _, v in pairs(State.Tabs) do
                v.Content.Visible = false
                v.Button.BackgroundColor3 = Theme.Secondary
                v.Button.TextColor3 = Theme.TextDim
            end
            -- Activate this
            TabContent.Visible = true
            TabBtn.BackgroundColor3 = Theme.Accent
            TabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        end)

        State.Tabs[#State.Tabs + 1] = {
            Name = Name,
            Content = TabContent,
            Button = TabBtn,
            ConfigData = {},
            ApplyData = function(Data) 
                -- Internal apply logic for save/load
            end
        }

        TabObj.Content = TabContent
        TabObj.Button = TabBtn

        -- ELEMENTS
        function TabObj:Section(Text)
            local Sec = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 25),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            local SecText = Utility:Create("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                Text = Text,
                TextSize = 14,
                Font = Enum.Font.GothamBold,
                TextColor3 = Theme.Accent,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = Sec
            })
            local Underline = Utility:Create("Frame", {
                Size = UDim2.new(0, 20, 0, 1),
                Position = UDim2.new(0, 5, 1, -5),
                BackgroundColor3 = Theme.Accent,
                Parent = Sec
            })
        end

        function TabObj:Button(Text, Callback)
            local Btn = Utility:Create("TextButton", {
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundColor3 = Theme.Secondary,
                Text = Text,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                ZIndex = 10,
                Parent = TabContent
            })
            Utility:Circle(Btn, 6)
            Utility:Stroke(Btn, Theme.Border)
            
            Btn.MouseButton1Click:Connect(function()
                Utility:Tween(Btn, {0.1}, {BackgroundColor3 = Theme.Accent})
                task.wait(0.1)
                Utility:Tween(Btn, {0.1}, {BackgroundColor3 = Theme.Secondary})
                if Callback then Callback() end
            end)
        end

        function TabObj:Toggle(Text, Default, Callback)
            Default = Default or false
            local Tog = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            
            local Lbl = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -50, 1, 0),
                Text = Text,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = Tog
            })

            local Btn = Utility:Create("TextButton", {
                Size = UDim2.new(0, 40, 0, 20),
                Position = UDim2.new(1, -45, 0.5, -10),
                BackgroundColor3 = Theme.Border,
                Text = "",
                Parent = Tog
            })
            Utility:Circle(Btn, 20)
            
            local Indicator = Utility:Create("Frame", {
                Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0, 2, 0.5, -8),
                BackgroundColor3 = Color3.fromRGB(255,255,255),
                Parent = Btn
            })
            Utility:Circle(Indicator, 20)

            local State = Default
            local function Update()
                if State then
                    Utility:Tween(Btn, {0.2}, {BackgroundColor3 = Theme.Accent})
                    Utility:Tween(Indicator, {0.2, Enum.EasingStyle.Back}, {Position = UDim2.new(1, -18, 0.5, -8)})
                else
                    Utility:Tween(Btn, {0.2}, {BackgroundColor3 = Theme.Border})
                    Utility:Tween(Indicator, {0.2, Enum.EasingStyle.Back}, {Position = UDim2.new(0, 2, 0.5, -8)})
                end
                TabObj.ConfigData[Text] = State
                if Callback then Callback(State) end
            end
            
            -- Init
            if Default then Update() end

            Btn.MouseButton1Click:Connect(function()
                State = not State
                Update()
            end)

            return {
                Set = function(v) State = v Update() end,
                Get = function() return State end
            }
        end

        function TabObj:Slider(Text, Min, Max, Default, Callback)
            Min, Max, Default = Min or 0, Max or 100, Default or 50
            local Sli = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 40),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            
            local Info = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -50, 0, 20),
                Text = Text .. ": " .. Default,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = Sli
            })

            local Bar = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 4),
                Position = UDim2.new(0, 0, 0, 25),
                BackgroundColor3 = Theme.Border,
                Parent = Sli
            })
            Utility:Circle(Bar, 2)

            local Fill = Utility:Create("Frame", {
                Size = UDim2.new((Default-Min)/(Max-Min), 0, 1, 0),
                BackgroundColor3 = Theme.Accent,
                Parent = Bar
            })
            Utility:Circle(Fill, 2)

            local Dragging = false
            local function Update(Input)
                local Pos = math.clamp((Input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
                local Val = math.floor(Min + (Pos * (Max - Min)))
                Fill.Size = UDim2.new(Pos, 0, 1, 0)
                Info.Text = Text .. ": " .. Val
                TabObj.ConfigData[Text] = Val
                if Callback then Callback(Val) end
            end

            Bar.InputBegan:Connect(function(Input)
                if Input.UserInputType == Enum.UserInputType.MouseButton1 or Input.UserInputType == Enum.UserInputType.Touch then
                    Dragging = true
                    Update(Input)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(Input)
                if Input.UserInputType == Enum.UserInputType.MouseButton1 or Input.UserInputType == Enum.UserInputType.Touch then
                    Dragging = false
                end
            end)

            UserInputService.InputChanged:Connect(function(Input)
                if Dragging then Update(Input) end
            end)
        end

        function TabObj:Input(Text, Placeholder, Callback)
            local Inp = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            local Lbl = Utility:Create("TextLabel", {
                Size = UDim2.new(0, 100, 1, 0),
                Text = Text,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = Inp
            })
            local Box = Utility:Create("TextBox", {
                Size = UDim2.new(1, -110, 0, 25),
                Position = UDim2.new(0, 105, 0.5, -12),
                BackgroundColor3 = Theme.Secondary,
                PlaceholderColor3 = Theme.TextDim,
                TextColor3 = Theme.Text,
                PlaceholderText = Placeholder or "Type here...",
                Text = "",
                ClearTextOnFocus = false,
                Parent = Inp
            })
            Utility:Circle(Box, 4)
            Utility:Stroke(Box, Theme.Border)
            Box.FocusLost:Connect(function(Enter)
                if Enter then
                    TabObj.ConfigData[Text] = Box.Text
                    if Callback then Callback(Box.Text) end
                end
            end)
            return {
                Set = function(t) Box.Text = t end,
                Get = function() return Box.Text end
            }
        end

        function TabObj:Dropdown(Text, Options, Default, Callback)
            Options = Options or {}
            Default = Default or Options[1]
            local DD = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            local Btn = Utility:Create("TextButton", {
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundColor3 = Theme.Secondary,
                Text = Text .. ": " .. Default,
                TextColor3 = Theme.Text,
                TextXAlignment = Enum.TextXAlignment.Left,
                Font = Enum.Font.GothamSemibold,
                Parent = DD
            })
            Utility:Circle(Btn, 6)
            Utility:Stroke(Btn, Theme.Border)
            Utility:Padding(Btn, 0,0,0,0, 10, 0)

            local List = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 0),
                Position = UDim2.new(0, 0, 0, 35),
                BackgroundColor3 = Theme.Secondary,
                Visible = false,
                ClipsDescendants = true,
                Parent = DD
            })
            Utility:Circle(List, 6)
            Utility:Stroke(List, Theme.Border)
            
            local Layout = Instance.new("UIListLayout", List)
            Layout.Padding = UDim.new(0, 2)

            local Open = false
            Btn.MouseButton1Click:Connect(function()
                Open = not Open
                List.Visible = Open
                if Open then
                    Utility:Tween(List, {0.2}, {Size = UDim2.new(1, 0, 0, math.min(#Options * 25, 150))})
                else
                    Utility:Tween(List, {0.2}, {Size = UDim2.new(1, 0, 0, 0)})
                end
            end)

            local function Refresh()
                for _, c in pairs(List:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for i, v in pairs(Options) do
                    local O = Utility:Create("TextButton", {
                        Size = UDim2.new(1, 0, 0, 25),
                        BackgroundTransparency = 1,
                        Text = v,
                        TextColor3 = Theme.TextDim,
                        Font = Enum.Font.Gotham,
                        TextXAlignment = Enum.TextXAlignment.Left,
                        Parent = List
                    })
                    Utility:Padding(O, 0,0,0,0, 10, 0)
                    O.MouseButton1Click:Connect(function()
                        Open = false
                        List.Visible = false
                        List.Size = UDim2.new(1, 0, 0, 0)
                        Btn.Text = Text .. ": " .. v
                        if Callback then Callback(v) end
                    end)
                end
            end

            Refresh()

            return {
                Refresh = function(newOpts) Options = newOpts Refresh() end,
                Set = function(v) Btn.Text = Text .. ": " .. v end
            }
        end
        
        function TabObj:ColorPicker(Text, Default, Callback)
            Default = Default or Color3.fromRGB(255, 255, 255)
            local CP = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            
            local Lbl = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -50, 1, 0),
                Text = Text,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = CP
            })
            
            local Preview = Utility:Create("TextButton", {
                Size = UDim2.new(0, 30, 0, 25),
                Position = UDim2.new(1, -35, 0.5, -12.5),
                BackgroundColor3 = Default,
                Parent = CP
            })
            Utility:Circle(Preview, 4)
            Utility:Stroke(Preview, Theme.Border)

            local CP_Window = Utility:Create("Frame", {
                Size = UDim2.new(0, 250, 0, 180),
                Position = UDim2.new(0.5, -125, 0.5, -90),
                BackgroundColor3 = Theme.Secondary,
                Visible = false,
                Parent = ScreenGui
            })
            Utility:Circle(CP_Window, 8)
            Utility:Stroke(CP_Window, Theme.Border)
            
            -- Saturation
            local SatFrame = Utility:Create("Frame", {
                Size = UDim2.new(1, -20, 0, 20),
                Position = UDim2.new(0, 10, 0, 10),
                BackgroundColor3 = Color3.fromHSV(0, 1, 1),
                Parent = CP_Window
            })
            local SatGrad = Instance.new("UIGradient", SatFrame)
            SatGrad.Color = ColorSequence.new(Color3.fromRGB(255,0,0), Color3.fromRGB(0,0,255))
            -- Custom Saturation Gradient Logic is complex in one file, using HUE slider instead
            
            local HueSlider = Utility:Create("Frame", {
                Size = UDim2.new(1, -20, 0, 20),
                Position = UDim2.new(0, 10, 0, 40),
                BackgroundColor3 = Color3.fromRGB(255,255,255),
                Parent = CP_Window
            })
            local HueGrad = Instance.new("UIGradient", HueSlider)
            HueGrad.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
                ColorSequenceKeypoint.new(0.16, Color3.fromRGB(255, 0, 255)),
                ColorSequenceKeypoint.new(0.33, Color3.fromRGB(0, 0, 255)),
                ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 255)),
                ColorSequenceKeypoint.new(0.66, Color3.fromRGB(0, 255, 0)),
                ColorSequenceKeypoint.new(0.83, Color3.fromRGB(255, 255, 0)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0))
            })
            
            local HKnob = Utility:Create("Frame", {
                Size = UDim2.new(0, 10, 1, 4),
                Position = UDim2.new(0.5, -5, 0, -2),
                BackgroundColor3 = Color3.fromRGB(255,255,255),
                Parent = HueSlider
            })
            Utility:Stroke(HKnob, Color3.fromRGB(0,0,0))

            local SatSlider = Utility:Create("Frame", {
                Size = UDim2.new(1, -20, 0, 20),
                Position = UDim2.new(0, 10, 0, 70),
                BackgroundColor3 = Color3.fromHSV(0, 0, 1),
                Parent = CP_Window
            })
            local SKnob = Utility:Create("Frame", {
                Size = UDim2.new(0, 10, 1, 4),
                Position = UDim2.new(1, -10, 0, -2),
                BackgroundColor3 = Color3.fromRGB(0,0,0),
                Parent = SatSlider
            })
            
            local ValSlider = Utility:Create("Frame", {
                Size = UDim2.new(1, -20, 0, 20),
                Position = UDim2.new(0, 10, 0, 100),
                BackgroundColor3 = Color3.fromRGB(0,0,0),
                Parent = CP_Window
            })
            local VKnob = Utility:Create("Frame", {
                Size = UDim2.new(0, 10, 1, 4),
                Position = UDim2.new(1, -10, 0, -2),
                BackgroundColor3 = Color3.fromRGB(255,255,255),
                Parent = ValSlider
            })

            local CloseCP = Utility:Create("TextButton", {
                Size = UDim2.new(0, 80, 0, 25),
                Position = UDim2.new(0.5, -40, 1, -35),
                Text = "Select",
                BackgroundColor3 = Theme.Accent,
                Parent = CP_Window
            })
            Utility:Circle(CloseCP, 4)

            -- Logic
            local SelectedColor = Default
            local H, S, V = Color3.toHSV(Default)
            
            local function UpdateUI()
                HKnob.Position = UDim2.new(H, -5, 0, -2)
                SKnob.Position = UDim2.new(S, -5, 0, -2)
                VKnob.Position = UDim2.new(V, -5, 0, -2)
                SatSlider.BackgroundColor3 = Color3.fromHSV(H, 1, 1)
            end
            UpdateUI()

            local DragH = false
            HueSlider.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then DragH = true end end)
            UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then DragH = false end end)
            UserInputService.InputChanged:Connect(function(i)
                if DragH then
                    H = math.clamp((i.Position.X - HueSlider.AbsolutePosition.X) / HueSlider.AbsoluteSize.X, 0, 1)
                    UpdateUI()
                    SelectedColor = Color3.fromHSV(H, S, V)
                    Preview.BackgroundColor3 = SelectedColor
                end
            end)

            local DragS = false
            SatSlider.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then DragS = true end end)
            UserInputService.InputChanged:Connect(function(i)
                if DragS then
                    S = math.clamp((i.Position.X - SatSlider.AbsolutePosition.X) / SatSlider.AbsoluteSize.X, 0, 1)
                    UpdateUI()
                    SelectedColor = Color3.fromHSV(H, S, V)
                    Preview.BackgroundColor3 = SelectedColor
                end
            end)

            local DragV = false
            ValSlider.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then DragV = true end end)
            UserInputService.InputChanged:Connect(function(i)
                if DragV then
                    V = math.clamp((i.Position.X - ValSlider.AbsolutePosition.X) / ValSlider.AbsoluteSize.X, 0, 1)
                    UpdateUI()
                    SelectedColor = Color3.fromHSV(H, S, V)
                    Preview.BackgroundColor3 = SelectedColor
                end
            end)

            Preview.MouseButton1Click:Connect(function()
                CP_Window.Visible = true
                CP_Window.Size = UDim2.new(0, 250, 0, 0)
                Utility:Tween(CP_Window, {0.2}, {Size = UDim2.new(0, 250, 0, 150)})
            end)

            CloseCP.MouseButton1Click:Connect(function()
                CP_Window.Visible = false
                if Callback then Callback(SelectedColor) end
            end)
        end

        function TabObj:Keybind(Text, Default, Callback)
            Default = Default or Enum.KeyCode.F
            local KB = Utility:Create("Frame", {
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundTransparency = 1,
                Parent = TabContent
            })
            local Lbl = Utility:Create("TextLabel", {
                Size = UDim2.new(1, -120, 1, 0),
                Text = Text,
                TextColor3 = Theme.Text,
                Font = Enum.Font.GothamSemibold,
                TextXAlignment = Enum.TextXAlignment.Left,
                BackgroundTransparency = 1,
                Parent = KB
            })
            local Btn = Utility:Create("TextButton", {
                Size = UDim2.new(0, 100, 0, 25),
                Position = UDim2.new(1, -110, 0.5, -12),
                BackgroundColor3 = Theme.Secondary,
                Text = "["..Default.Name.."]",
                TextColor3 = Theme.Accent,
                Parent = KB
            })
            Utility:Circle(Btn, 4)
            Utility:Stroke(Btn, Theme.Border)

            local Waiting = false
            Btn.MouseButton1Click:Connect(function()
                Waiting = true
                Btn.Text = "[...]"
            end)

            UserInputService.InputBegan:Connect(function(Input, GPE)
                if Waiting and not GPE then
                    Waiting = false
                    Default = Input.KeyCode
                    Btn.Text = "["..Default.Name.."]"
                    if Callback then Callback(Default) end
                end
            end)
            
            return {
                Set = function(k) Default = k Btn.Text = "["..Default.Name.."]" end
            }
        end
        
        return TabObj
    end

    return Window
end

return Library
